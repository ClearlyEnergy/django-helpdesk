{% extends "helpdesk/base.html" %}

{% load i18n bootstrap4form %}

{% block helpdesk_title %}{% blocktrans %} {{ action }} Form {% endblocktrans %}{% endblock %}

{% block helpdesk_breadcrumb %}
<li class="breadcrumb-item">
    <a href="{% url 'helpdesk:user_settings' %}">{% trans "Settings" %}</a>
</li>
<li class="breadcrumb-item">
    <a href="{% url 'helpdesk:system_settings' %}">{% trans "System Settings" %}</a>
</li>
<li class="breadcrumb-item">
    <a href="{% url 'helpdesk:maintain_forms' %}">{% trans "Maintain Forms" %}</a>
</li>
<li class="breadcrumb-item active">
    {% blocktrans with formtype.name as fn%}{{ action }} {{ fn }}{% endblocktrans %}
</li>
{% endblock %}

{% block helpdesk_body %}
    <div class="col-xs-6">
        <div class="panel panel-default">
            <div class="panel-body"><h2>{% blocktrans %} {{ action }} Form {% endblocktrans %}</h2>
                {% if form.errors %}<p class="text-danger">{% for error in form.errors %}{% trans "Error: " %}{{ error }}<br>{% endfor %}</p>{% endif %}
                {% if formset.non_form_errors %}
                    <div class="alert alert-danger" role="alert">
                        <a class="close" data-dismiss="alert">&times;</a>
                            <strong>Custom Field Error</strong>: {{ formset.non_form_errors.as_text }}
                    </div>
                {% endif %}
                
                {% if formset.errors %}
                    {% for form_errors in formset.errors %}
                        {% if form_errors %}
                        <div class="alert alert-danger" role="alert">
                            <a class="close" data-dismiss="alert">&times;</a>
                                <strong>Custom Field #{{ forloop.counter}}</strong> </br>
                                {% for key, error in form_errors.items %} {{ key }}: {{ error.as_text }} {% endfor %}
                        </div>
                        {% endif %}
                    
                    {% endfor %}
                {% endif %}
                <form id='edit_form' method='post'>
                    {% csrf_token %}
                    <fieldset>
                        {{ form|bootstrap4form }}
                        {% include 'helpdesk/include/collapsible_formset.html' with formset=form.customfield_formset formset_title="Custom Field" formset_type="custom_field" copy_queryset=form.copy_queryset %}
                        <div class='buttons form-group mt-2'>
                            <button type='submit' id='submit' onclick="removeEmpty()" class="btn btn-primary btn" value='{% trans "Save Changes" %}'>
                                {% if action == "Create" %}
                                    Create Form
                                {% else %}
                                    Save Changes
                                {% endif %}
                            </button>
                            <a href="{% if action == "Create" %}{% url 'helpdesk:delete_form' formtype.id %}{% else %}{% url 'helpdesk:maintain_forms' %} {% endif %}">
                                <button type="button" class="btn btn-danger">{% trans "Cancel" %}</button>
                            </a>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>

    <script type='text/javascript' language='javascript'>
        $(document).ready(function () {
            defaults = ['queue','submitter_email', 'contact_name','title','description','building_name','building_address','building_id','pm_id','attachment','due_date','priority','cc_emails']
            for (const field_name of document.querySelectorAll('[name$="-field_name"]')) {
                idx = defaults.indexOf(field_name.value)
                if (idx >= 0) {
                    field_name.readOnly = true;
                    field_name.required = false;
                    defaults.splice(idx, 1)
                } else {
                    field_name.required = true;
                }
            }

            document.querySelector('#custom_field_empty [name$="-field_name"]').required = false;

            {# Bandaid fix for adding asterisks to required fields while the rest of the form is handled by bootstrap4form #}
            for (const required_field of document.querySelectorAll('[required]')) {
                document.querySelector('label[for=' + required_field.id + ']').innerHTML += '<span style="color:red;">*</span>'
            }
        })

        function removeEmpty() {
            if (document.querySelector('#edit_form').checkValidity()) {
                document.querySelector('#custom_field_empty').remove()
            }
        }
    </script>   
    {% include 'helpdesk/include/edit_md_preview_script.html' %} 
{% endblock %}
