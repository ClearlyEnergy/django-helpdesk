{% extends "helpdesk/base.html" %}

{% load i18n humanize static in_list %}

{% block helpdesk_title %} {% trans "Notifications" %} {% endblock %}

{% block helpdesk_breadcrumb %}
<li class="breadcrumb-item">
    <a href="{% url 'helpdesk:notifications' %}">{% trans "Notifications" %}</a>
</li>
<li class="breadcrumb-item active">Overview</li>
{% endblock %}

{% block helpdesk_body %}
<div class="d-flex align-items-center">    
    
    <div class="input-group justify-content-end">

        
        <div class="input-group-append">
            <button id="mark_as_read_btn" class="btn btn-outline-primary rounded-left font-weight-semibold" type="button" method="POST"> {% csrf_token %} Mark As Read <i class="fa fa-check mr-1"></i></button>
            <button id="delete_btn" class="btn btn-outline-danger font-weight-semibold" type="button" method="POST"> {% csrf_token %} Delete Selected <i class="fa fa-trash-alt mr-1"></i></button>
        </div>
        <div class="input-group-prepend">
            <label class="input-group-text bg-white border-0">Select:</label>
        </div>
        
        <div class="input-group-append">
            <button id="select_all_btn" class="btn btn-outline-primary rounded-left font-weight-semibold" type="button">All <i class="fa fa-plus-circle mr-1"></i></button>
            <button id="select_none_btn" class="btn btn-outline-danger font-weight-semibold" type="button">None <i class="fa fa-times-circle mr-1"></i></button>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-sm-8 col-md-9 col-lg-10 order-1 pl-3">
        <div id="query_card" class="card mb-2">
            <!-- Notifications-->
            <div class="card-header">
                <i class="fas fa-bell"></i>
                {% trans "Notifications" %}
            </div>

            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm m-0" id="dataTable" width="100%" cellspacing="0">
                        <thead class="thead-light">
                            <tr id="headers">
                                <th class="filter-top" data-colname="checkbox" scope="col"></th>
                                <th class="filter-top" data-colname="message" scope="col">Message</th>
                                <th class="filter-top" data-colname="date" scope="col">Date</th>
                                <th class="filter-top" data-colname="ticket_link" scope="col">Ticket</th>
                                
                            </tr>

                            <tr>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                              </tr>
                        </thead>
                        <tbody>
                            {% for notification in notifications %}
                                <tr {% if notification.is_read %} style="background-color: lightgray;" {% endif %}>
                                    <td>
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" name="notification_checkbox" class="custom-control-input notification_multi_select" id="newCustomCheck{{ forloop.counter }}" value="{{ notification.id }}">
                                            <label class="custom-control-label" for="newCustomCheck{{ forloop.counter }}"></label>
                                        </div>
                                    </td>
                                    <td>{{notification.message}}</td>
                                    <td title="{{ notification.created }}">{{notification.get_time_since_created}}</td>
                                    <td><a href="{% url 'helpdesk:mark_notification_as_read' notification.id%}">[queue-{{notification.ticket.queue}}] {{notification.ticket.title}}</a></td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="4">No Notifications</td>
                                </tr>
                            {% endfor %}

                        </tbody>
                    </table>
                </div>
                <!-- Pagination Toolbar -->
                <div class="d-flex flex-wrap border-top px-2 py-2" style="//background-color: #f7f7f7">
                    {% with 't_page' as page_var %}

                    <div class="mr-auto d-flex align-items-center ml-2">Showing {{ notification_index_start }}-{{ notification_index_end }} of {{ notification_total }}<em><span class="select_count"></span></em></div>
                    <div class="flex-fill justify-content-end">
                        <div class="btn-toolbar float-right" role="toolbar" style="bottom: 0;">
                            <div class="btn-group mr-2" role="group">
                                {% if notifications.has_previous %}
                                <button class="btn btn-primary font-weight-bold" onclick="paginatedQuery(1, false)">First</button>
                                <button class="btn btn-primary font-weight-bold" onclick="paginatedQuery({{ notifications.previous_page_number }})">Previous</button>
                                {% else %}
                                <button class="btn btn-primary font-weight-bold disabled">First</button>
                                <button class="btn btn-primary font-weight-bold disabled">Previous</button>
                                {% endif %}
                            </div>
                            <div class="btn-group mr-2" role="group">
                                {% with 3 as thresh %}
                                {% for i in notifications.paginator.page_range %}
                                {% if notifications.number == i %}
                                <button class="btn btn-outline-primary active font-weight-bold">{{ i }}</button>
                                {% elif i <= notifications.number|add:5 and i >= notifications.number|add:-5 %}
                                <button class="btn btn-outline-primary font-weight-bold" onclick="paginatedQuery({{ i }})">{{ i }}</button>
                                {% endif %}
                                {% endfor %}
                                {% endwith %}
                            </div>
                            <div class="btn-group" role="group">
                                {% if notifications.has_next %}
                                <button class="btn btn-primary font-weight-bold" onclick="paginatedQuery({{ notifications.next_page_number }}, false)">Next</button>
                                <button class="btn btn-primary font-weight-bold" onclick="paginatedQuery({{ notifications.paginator.num_pages }}, false)">Last</button>
                                {% else %}
                                <button class="btn btn-primary font-weight-bold disabled">Next</button>
                                <button class="btn btn-primary font-weight-bold disabled">Last</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                </div>
                <!-- / Pagination Toolbar -->
                                

                
            </div>
    
    </div>

    <form method="get" id="query_form" action="{% url 'helpdesk:notifications' %}">

        <!-- Hidden Fields -->

        <!-- Paginator fields -->
        <input type='hidden' id='n' name='n' value="{{ notifications_per_page }}"/>
        <input type='hidden' id='p' name='p' value="1"/>

        <input type='hidden' id='saved-query' name='saved-query' value="{{ saved_query.id }}"/>
    </form>

    
    </div>
</div>
{% endblock %}

{% block helpdesk_js %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>

<script>
    var selected = [];
    var all_notification_ids = [];

    $(document).ready(function () {

        for (const id of document.querySelectorAll(".notification_multi_select")) {
            all_notification_ids.push(id.value)
        }

        $("#select_all_btn").click(function () {
            $(".notification_multi_select").prop('checked', true);
            all_notification_ids.forEach(function(e) {
                if (!selected.includes(String(e))) {
                    selected.push(String(e));
                }
            })
            
            
        });

        $("#select_none_btn").click(function () {
            $(".notification_multi_select").prop('checked', false);
            selected = [];
            
        });

        $(".notification_multi_select").click(function () {
            if ($(this).prop('checked')) {
                if (!selected.includes($(this).val())) {
                    selected.push($(this).val())
                }
            } else {
                if (selected.includes($(this).val())) {
                    selected.pop($(this).val())
                } 
            }

        })
        
        $("#delete_btn").click(function (e) {
            if (selected.length > 0) {
                console.log(selected)
                $.ajax({
                    url: "{% url 'helpdesk:delete_selected_notifications' %}",
                    type: 'POST',
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        'selected[]': selected
                    },
                    success: function(response) {
                        console.log(response)
                        location.reload();
                    }
                });
            } else {
                console.log("NOTHING HERE")
                location.reload();
            }
        })

        $('#mark_as_read_btn').click(function() {
            if (selected.length > 0) {
                $.ajax({
                    url: "{% url 'helpdesk:mark_selected_as_read' %}",
                    type: 'POST',
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        'selected[]': selected
                    },
                    success: function(response) {
                        console.log(response);
                        location.reload();
                    }
                });
            } else {
                console.log("NOTHING HERE");
                location.reload();
            }
        })
    });

    function toggleQuerySelector() {
        let queryToggle = !(localStorage.getItem("helpdesk.show_query") === 'true');

        $('#show_query_text').toggle(!queryToggle);
        $('#hide_query_text').toggle(queryToggle);
        $("#query_select").toggle(queryToggle);
        let resultsCol = $("#query_card").parent();
        resultsCol.toggleClass('col-12', !queryToggle);
        resultsCol.toggleClass('col-sm-8', queryToggle);
        resultsCol.toggleClass('col-md-9', queryToggle);
        resultsCol.toggleClass('col-lg-10', queryToggle);

        localStorage.setItem("helpdesk.show_query", queryToggle);
    }

    function updateNotificationsPerPage(notifications_per_page) {
        document.getElementById('n').value = notifications_per_page;
        paginatedQuery();
    }

    function paginatedQuery(page=1, clearSavedQuery=false) {
        document.getElementById('p').value = page;

        /*
        for (const colfilter of document.querySelectorAll('[data-colfilter]')) {
            document.getElementById(colfilter.dataset['colfilter'] + '_filter').value = colfilter.value
        }
        */

        if (!clearSavedQuery && $("#saved-query").val() !== '') {
            // keep the saved query input and erase everything else
            $("#query_form").find(':input:not(#saved-query)').not(":input[type=hidden]").filter(function() {
                return true;
            }).attr('disabled', 'disabled');
            document.forms['query_form'].submit();
        } else {
            if (clearSavedQuery) {
                // remove the saved query before submitting the form
                $("#query_form").find("#saved-query").attr('disabled', 'disabled');
            } else if ($("#saved-query").val() === 'None') {
                $("#saved-query").val('');
            }
            // removes empty inputs from form
            $("#query_form").find(':input').filter(function() {
                return !($(this).is('input:checkbox:checked') || !$(this).is('input:checkbox') && $(this).val() !== '');
            }).attr('disabled', 'disabled');

            document.forms['query_form'].submit();
        }
    }

</script>
{% endblock %}